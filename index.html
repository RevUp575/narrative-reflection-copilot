<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Narrative Reflection Co-Pilot</title>
  <link href="./dist/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Narrative Reflection Co-Pilot</h1>
    <div id="chat-container" class="h-96 overflow-y-auto p-4 bg-gray-50 rounded mb-4">
      <div class="text-gray-600 mb-2">Welcome! Let's create a story to reflect on your experiences.</div>
    </div>
    <form id="user-input-form" class="flex">
      <input id="user-input" type="text" class="flex-1 p-2 border rounded-l-lg focus:outline-none" placeholder="Type your response..." required>
      <button type="submit" class="bg-blue-500 text-white p-2 rounded-r-lg hover:bg-blue-600">Send</button>
    </form>
    <p class="text-center mt-4 text-gray-500">Premium features (longer stories, audio) coming soon!</p>
  </div>

  <script>
    // Ensure script runs after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Script initialized: DOM loaded');
      const chatContainer = document.getElementById('chat-container');
      const userInputForm = document.getElementById('user-input-form');
      const userInput = document.getElementById('user-input');

      // Check for missing DOM elements
      if (!userInputForm || !userInput || !chatContainer) {
        console.error('Error: Missing DOM elements. Check IDs in HTML.');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-600 mb-2';
        errorDiv.textContent = 'Error: Unable to load chat interface. Please refresh the page.';
        document.querySelector('.bg-white').appendChild(errorDiv);
        return;
      }

      let step = 0;
      const questions = [
        'What challenge or situation are you facing right now?',
        'How does this situation make you feel?',
        'What do you hope to achieve or learn from this experience?'
      ];
      let userResponses = [];

      // Add a message to the chat container
      function addMessage(content, isUser = false) {
        console.log('Adding message:', content);
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-2 ${isUser ? 'text-right' : 'text-left'}`;
        messageDiv.innerHTML = `<span class="inline-block p-2 rounded-lg ${isUser ? 'bg-blue-100' : 'bg-gray-200'}">${content}</span>`;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Generate a mock story (replace with xAI Grok API later)
      async function generateStory(responses) {
        const prompt = `Create a short metaphorical story (200-300 words) based on the following user input:
        Challenge: ${responses[0]}
        Feelings: ${responses[1]}
        Aspiration: ${responses[2]}
        Use symbolism and allegory to reflect the user's situation.`;
        
        try {
          const mockStory = `Once, in a vast forest, a weary traveler named Elara faced a river too wide to cross. The river, turbulent and unyielding, mirrored Elara's heart—heavy with doubt and fear. Each attempt to wade through left her colder, yet she yearned to reach the golden meadow beyond, where clarity bloomed. One night, a firefly appeared, its glow faint but steady. "Build a bridge," it whispered, "not of stone, but of trust." Elara gathered fallen branches—her small acts of courage—and wove them into a fragile path. With each step, the river calmed, reflecting her growing hope. At last, she stood in the meadow, where the sun warmed her soul, and she knew: the bridge was within her all along.`;
          return mockStory;
        } catch (error) {
          console.error('Error generating story:', error);
          return 'Sorry, there was an error generating your story. Please try again.';
        }
      }

      // Handle form submission
      userInputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Submit event triggered');
        const input = userInput.value.trim();
        if (!input) {
          console.log('Empty input, ignoring submission');
          return;
        }

        addMessage(input, true);
        userResponses.push(input);
        userInput.value = '';

        if (step < questions.length) {
          addMessage(questions[step]);
          step++;
        } else {
          addMessage('Thank you! Generating your story...');
          const story = await generateStory(userResponses);
          addMessage(`<b>Your Story:</b><br>${story}`);
          addMessage('What does this story mean to you? How does it reflect your situation?');
          step = 0;
          userResponses = [];
        }
      });

      // Start with first question
      addMessage(questions[0]);
      step++;
    });
  </script>
</body>
</html>